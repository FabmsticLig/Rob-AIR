// Modèles d'yeux par défaut
var eyesstraight = [
	['#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000','#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#FFFFFF','#000000','#00FF00','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#00FF00','#000000','#FFFFFF','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000','#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000']
];

var eyesright = [
	['#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000','#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#00FF00','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#00FF00','#FFFFFF','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000','#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000']
];

var eyesleft = [
	['#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000','#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#FFFFFF','#00FF00','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#00FF00','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000','#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000']
];

var eyestop = [
	['#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000','#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000'],
	['#000000','#FFFFFF','#000000','#00FF00','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#00FF00','#000000','#FFFFFF','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000','#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000']
];

var eyesbottom = [
	['#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000','#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#000000','#000000','#FFFFFF','#000000'],
	['#000000','#FFFFFF','#000000','#00FF00','#000000','#FFFFFF','#000000','#000000','#FFFFFF','#000000','#00FF00','#000000','#FFFFFF','#000000'],
	['#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000','#000000','#000000','#FFFFFF','#FFFFFF','#FFFFFF','#000000','#000000']
];

var eyesexclamations = [
	['#000000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#000000','#000000'],
	['#000000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#000000','#000000'],
	['#000000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#000000','#000000'],
	['#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000'],
	['#000000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000','#000000','#000000']
];

var eyesinterogations = [
	['#000000','#0000FF','#0000FF','#0000FF','#000000','#0000FF','#0000FF','#0000FF','#000000','#0000FF','#0000FF','#0000FF','#000000','#000000'],
	['#000000','#0000FF','#000000','#0000FF','#000000','#0000FF','#000000','#0000FF','#000000','#0000FF','#000000','#0000FF','#000000','#000000'],
	['#000000','#000000','#0000FF','#0000FF','#000000','#000000','#0000FF','#0000FF','#000000','#000000','#0000FF','#0000FF','#000000','#000000'],
	['#000000','#000000','#0000FF','#000000','#000000','#000000','#0000FF','#000000','#000000','#000000','#0000FF','#000000','#000000','#000000'],
	['#000000','#000000','#00FF00','#000000','#000000','#000000','#00FF00','#000000','#000000','#000000','#00FF00','#000000','#000000','#000000']
];

var eyesstop = [
	['#FF0000','#FF0000','#FF0000','#000000','#FF0000','#FF0000','#FF0000','#000000','#FF0000','#FF0000','#FF0000','#000000','#FF0000','#FF0000'],
	['#FF0000','#000000','#000000','#000000','#000000','#FF0000','#000000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#FF0000'],
	['#FF0000','#FF0000','#FF0000','#000000','#000000','#FF0000','#000000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000'],
	['#000000','#000000','#FF0000','#000000','#000000','#FF0000','#000000','#000000','#FF0000','#000000','#FF0000','#000000','#FF0000','#000000'],
	['#FF0000','#FF0000','#FF0000','#000000','#000000','#FF0000','#000000','#000000','#FF0000','#FF0000','#FF0000','#000000','#FF0000','#000000']
];

var eyeshello = [
	['#FFFFFF','#000000','#FFFFFF','#000000','#00FF00','#00FF00','#000000','#FF0000','#000000','#FF0000','#000000','#FF00FF','#FF00FF','#FF00FF'],
	['#FFFFFF','#000000','#FFFFFF','#000000','#00FF00','#000000','#000000','#FF0000','#000000','#FF0000','#000000','#FF00FF','#000000','#FF00FF'],
	['#FFFFFF','#FFFFFF','#FFFFFF','#000000','#00FF00','#00FF00','#000000','#FF0000','#000000','#FF0000','#000000','#FF00FF','#000000','#FF00FF'],
	['#FFFFFF','#000000','#FFFFFF','#000000','#00FF00','#000000','#000000','#FF0000','#000000','#FF0000','#000000','#FF00FF','#000000','#FF00FF'],
	['#FFFFFF','#000000','#FFFFFF','#000000','#00FF00','#00FF00','#000000','#FF0000','#FF0000','#FF0000','#FF0000','#FF00FF','#FF00FF','#FF00FF']

];

var eyesvide = [
	['#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000'],
	['#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000'],
	['#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000'],
	['#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000'],
	['#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000','#000000']
];

var eyeserror = [
	['#FF0000','#FF0000','#FFFF00','#FFFF00','#FFFF00','#FF0000','#FF0000','#FF0000','#FFFF00','#FFFF00','#FFFF00','#FF0000','#FF0000','#FF0000'],
	['#FF0000','#000000','#FFFF00','#000000','#FFFF00','#FF0000','#000000','#FF0000','#FFFF00','#000000','#FFFF00','#FF0000','#000000','#FF0000'],
	['#FF0000','#FF0000','#FFFF00','#FFFF00','#FFFF00','#FF0000','#FF0000','#FF0000','#FFFF00','#000000','#FFFF00','#FF0000','#FF0000','#FF0000'],
	['#FF0000','#000000','#FFFF00','#FFFF00','#000000','#FF0000','#FF0000','#000000','#FFFF00','#000000','#FFFF00','#FF0000','#FF0000','#000000'],
	['#FF0000','#FF0000','#FFFF00','#000000','#FFFF00','#FF0000','#000000','#FF0000','#FFFF00','#FFFF00','#FFFF00','#FF0000','#000000','#FF0000']
];


var Eyes = {
	columns: 14,
	rows: 5,

	led_borders: false,

	_init: function(canvas) {
		if (canvas == undefined)
			this.canvas = document.getElementById('eyesCanvas');
		else
			this.canvas = canvas;
		this.canvas.style.backgroundColor = '#969696';

		this.matrix = new Array;
		for (var y = 0 ; y < this.rows ; ++y) {
			this.matrix[y] = new Array;
			for (var x = 0 ; x < this.columns ; ++x) {
				this.matrix[y][x] = '#000000';
			}
		}

		this.redraw();
	},

	set_eyes: function(id_or_mat) {
		if (id_or_mat instanceof Array)
			this.matrix = this.deserialize_matrix(id_or_mat);
		else
			this.matrix = this.predef_eyes[id_or_mat];
		this.redraw();
	},

	redraw: function() {
		for (var y = 0 ; y < this.rows ; ++y) {
			for (var x = 0 ; x < this.columns ; ++x) {
				this.draw_eye(x, y);
			}
		}
	},

	draw_eye: function(x, y) {
		// Because of anti-aliasing, drawing multiple times on the same
		// coordinates darkens the stroke. Clear the area to prevent that.
		var ctx = this.canvas.getContext('2d');
		ctx.clearRect(
			20 * x + 3,
			15 * y + 3,
			14,
			14);

		this.draw_circle(
			ctx,
			20 * x + 10,
			15 * y + 10,
			this.matrix[y][x],
			this.led_borders);
	},

	draw_circle: function(ctx, x, y, color, with_stroke) {
		ctx.beginPath();

		if (with_stroke) {
			ctx.arc(x, y, 6, 0, 2 * Math.PI);
			ctx.strokeStyle = "#505050";
			ctx.stroke();
		} else {
			ctx.arc(x, y, 5, 0, 2 * Math.PI);
		}

		if (color == '#000000')
			ctx.fillStyle = '#969696';
		else
			ctx.fillStyle = color;

		ctx.fill();
	},

	unflatten: function(mat) {
		var new_mat = new Array;
		var y = 0;

		while (mat.length > 0) {
			new_mat.push(new Array);

			for (var i = 0 ; i < this.columns ; ++i)
				new_mat[y].push(mat.shift());

			y++;
		}

		return new_mat;
	},

	deserialize_matrix: function(mat) {
		mat = mat.map(function(num) {
			var r = (num & 0xff0000) >> 16;
			var g = (num & 0x00ff00) >> 8;
			var b = (num & 0x0000ff);
			return '#'
				+ r.toString(16).padStart(2, '0')
				+ g.toString(16).padStart(2, '0')
				+ b.toString(16).padStart(2, '0');
		});
		return this.unflatten(mat);
	},

	EYESVIDE: 0,
	EYESSTRAIGHT: 1,
	EYESRIGHT: 2,
	EYESLEFT: 3,
	EYESTOP: 4,
	EYESBOTTOM: 5,
	EYESEXCLAMATIONS: 6,
	EYESINTEROGATIONS: 7,
	EYESSTOP: 8,
	EYESHELLO: 9,
	EYESERROR: 10,
	EYESCUSTOM: 254,

	predef_eyes: [
		eyesvide,
		eyesstraight,
		eyesright,
		eyesleft,
		eyestop,
		eyesbottom,
		eyesexclamations,
		eyesinterogations,
		eyesstop,
		eyeshello,
		eyeserror
	]
};

var EyesEditor = Object.create(Eyes);
Object.assign(EyesEditor, {
	led_borders: true,

	_init: function() {
		Eyes._init.call(this, document.getElementById('eyesGrid'));

		this.canvas.addEventListener(
			'mousedown', this.on_mouse.bind(this), false);
		this.canvas.addEventListener(
			'mousemove', this.on_mouse.bind(this), false);

		for (var i in this.tools) {
			var t = this.tools[i];
			document.getElementById(t + 'Tool').addEventListener(
				'click', this.set_tool.bind(this, t), false);
		}

		document.getElementById('colorPicker').addEventListener(
			'input', this.select_color.bind(this), false);
		document.getElementById('colorSpectrum').addEventListener(
			'click', this.on_spectrum.bind(this), false);

		document.getElementById('btn_sendEyes').addEventListener(
			'click', this.send.bind(this), false);
	},

	flatten: function() {
		return this.matrix.reduce(function(a, b) { return a.concat(b); });
	},

	send: function() {
		var flat = this.flatten();

		flat = flat.map(function(color) {
			var r = parseInt(color.substr(1, 2), 16);
			var g = parseInt(color.substr(3, 2), 16);
			var b = parseInt(color.substr(5, 2), 16);
			return r << 16 | g << 8 | b;
		});

		robairros.setEyesCustom(flat);
	},

	tools: ['eraser', 'paint', 'picker'],
	current_tool: '',
	paint_color: '#ffffff',

	set_tool: function(tool) {
		this.current_tool = tool;

		for (var i in this.tools) {
			var t = this.tools[i];
			document.getElementById(t + 'Tool').style.border = null;
		}

		document.getElementById(tool + 'Tool').style.border = '2px solid #666';
	},

	on_mouse: function(e) {
		if ((e.buttons & 1) == 0)
			return;

		var rect = this.canvas.getBoundingClientRect();
		var pixel_w = rect.width / this.columns;
		var pixel_h = rect.height / this.rows;

		var x = Math.floor(e.offsetX / pixel_w);
		var y = Math.floor(e.offsetY / pixel_h);

		switch (this.current_tool) {
		case 'eraser':
			this.matrix[y][x] = '#000000';
			this.draw_eye(x, y);
			break;
		case 'paint':
			this.matrix[y][x] = this.paint_color;
			this.draw_eye(x, y);
			break;
		case 'picker':
			this.paint_color = this.matrix[y][x];
			document.getElementById('paintTool').style.backgroundColor =
					this.paint_color;
			break;
		}
	},

	on_spectrum: function(e) {
		document.getElementById('colorPicker').value = Math.floor(e.offsetX);
		this.select_color({target: document.getElementById('colorPicker')});
	},

	select_color: function(e) {
		var value = parseInt(e.target.value);
		var minColor = 9; // the first few values mean "white"
		var maxValue = e.target.max;
		var colorBlocSize = (maxValue - minColor) / 6;

		var res = Math.floor(
			((value - minColor) % colorBlocSize) * 256 / colorBlocSize
		);

		var color;

		if (value < minColor)
			color = '#ffffff';
		else if (value < colorBlocSize + minColor)
			color = '#ff00' + res.toString(16);
		else if (value < 2 * colorBlocSize + minColor)
			color = '#' + (255 - res).toString(16) + '00ff';
		else if (value < 3 * colorBlocSize + minColor)
			color = '#00' + res.toString(16) + 'ff';
		else if (value < 4 * colorBlocSize + minColor)
			color = '#00ff' + (255 - res).toString(16);
		else if (value < 5 * colorBlocSize + minColor)
			color = '#' + res.toString(16) + 'ff00';
		else
			color = '#ff' + (255 - res).toString(16) + '00';

		document.getElementById('paintTool').style.backgroundColor = color;
		this.paint_color = color;
		this.set_tool('paint');
	}
});

window.addEventListener('load', Eyes._init.bind(Eyes, undefined), false);
window.addEventListener('load', EyesEditor._init.bind(EyesEditor), false);
window.addEventListener('load', Eyes.set_eyes.bind(Eyes, Eyes.EYESSTRAIGHT), false);
